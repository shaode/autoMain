<!DOCTYPE html>
<html>
<head>
    <title>适用于seaJS的自动打包工具</title>
    <link rel="stylesheet" href="https://a.alipayobjects.com/u/css/201403/2CBdFqHlTB.css">
    <style>
        body {
            background: #eee;
        }

        #file .item {
            display: inline-block;
            padding: 12px;
        }

        #file a {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        #file .dir-circle a:after {
            content: '>';
            margin-right: 1em;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>适用于seaJS的自动打包工具</h1>

    <p>目前仅支持utf-8的文件，以下改动即时生效。</p>

    <form class="form-horizontal" id="setting" role="form" action="/test/test.do" method="post" data-send-type="ajax">
        <div class="form-group">
            <label class="col-sm-3 control-label">Base</label>

            <div class="col-sm-7">
                <input type="text" id="url" name="url" class="form-control"/>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">根目录</label>

            <div class="col-sm-7">
                <input type="text" id="dir" name="dir" class="form-control" placeholder="请填写目录地址"/>
            </div>

        </div>
        <hr/>
        <h3>seaJS.<a href="https://github.com/seajs/seajs/issues/262">config</a></h3>

        <div class="form-group">
            <div class="col-sm-3 control-label">
                <p>vars，用逗号分隔</p>
            </div>

            <div class="col-sm-7">
                <textarea id="vars" name="vars" class="form-control" placeholder="locals=zh-cn,ts=20140306"></textarea>
            </div>

        </div>
        <div class="form-group">
            <div class="col-sm-3 control-label">
                <p>alias，建议用绝对路径<br>多个请换行</p>
            </div>
            <div class="col-sm-7">
                <textarea id="alias" name="alias" class="form-control"
                          placeholder="$ = http://xxx.cn/jquery/jquery/x.10.x/jquery"></textarea>
            </div>
        </div>
        <sub>没有银弹</sub>

        <h2>文件列表</h2>

        <div id="file-list">
            <div>文件路径：<a href="javascript:void(0)" class="J-dir-circle" data-dir="/">返回根目录</a>：<span
                    class="dir-circle J-path"></span></div>

            <div id="file">

            </div>
        </div>
    </form>
</div>
<script src="https://a.alipayobjects.com/u/js/201403/2CBe0eeWk1.js"></script>
<script src="https://a.alipayobjects.com/u/js/201403/2CBe8jBY5V.js"></script>
<style>

</style>
<script>

    var $url = $('#url')
    var $dir = $('#dir')
    var $vars = $('#vars')
    var $alias = $('#alias')

    if (localStorage) {
        $url.val(localStorage.url ? localStorage.url : location.origin)
        if (localStorage.dir) $dir.val(localStorage.dir)
        if (localStorage.vars) $vars.val(localStorage.vars)
        if (localStorage.alias) $alias.val(localStorage.alias)
    } else {
        $url.val(location.origin)
    }

    $dir.add($url).add($vars).add($alias).on('input', function (ev) {
        localStorage.url = $url.val()
        localStorage.dir = $dir.val()
        localStorage.vars = $vars.val()
        localStorage.alias = $alias.val()
        $.ajax({
            url: '/',
            type: 'get',
            data: $('#setting').serializeArray(),
            success: function () {
                getDir()
            }
        })
    }).eq(0).trigger('input')

    //读取目录下的所有文件
    var dirCircle = ''
    function getDir(path) {
        $.get('/readir' + (path ? path : '')).done(function (data) {
            var str = data.list.map(function (file) {
                if (file.isFile && /.js$/.test(file.name)) {
                    return '<div class="item J-file"><a>' + file.name + '</a></div>'
                } else if (file.isDirectory && !/^\./.test(file.name)) {
                    return '<div class="item J-directory" data-dir="' + file.name + '"><a>' + file.name + '</a></div>'
                }
            })
            $('#file').html(str)
            //处理面包屑
            dirCircle = data.base
            $('.J-path').html(data.base.split('\\').map(function (item) {
                return '<a data-dir="' + item + '" class="J-dir-circle">' + item + '</a>'
            }))
        })
    }

    //目录
    $(document).on('click', '.J-directory', function () {
        getDir(dirCircle + '/' + $(this).data('dir'))
    })

    //面包屑
    $(document).on('click', '.J-dir-circle', function () {
        var path = []
        $(this).prevAll().add(this).map(function (i, item) {
            path.push($(item).data('dir'))
        })
        if (path.length < 1) {
            return
        }
        getDir(path.reverse().join('/'))
    })

</script>
<!--显示目录-->
<script>
</script>
</body>
</html>